---
- name: Enforce strict password policy and set password expiry for existing users
  hosts: all
  become: true

  tasks:

    - name: Set password quality requirements in /etc/security/pwquality.conf
      copy:
        dest: /etc/security/pwquality.conf
        content: |
          difok = 5
          minlen = 12
          dcredit = -1
          ucredit = -1
          lcredit = -1
          ocredit = -1
          minclass = 4
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Set default password expiry policy in /etc/login.defs
      lineinfile:
        path: /etc/login.defs
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        create: yes
        backup: yes
      loop:
        - { regexp: '^PASS_MAX_DAYS', line: 'PASS_MAX_DAYS   90' }
        - { regexp: '^PASS_MIN_DAYS', line: 'PASS_MIN_DAYS   0' }
        - { regexp: '^PASS_WARN_AGE', line: 'PASS_WARN_AGE   7' }

    - name: Set password expiry policy for existing users (UID â‰¥ 1000, excluding root)
      shell: chage --maxdays 90 --mindays 0 --warndays 7 {{ item }}
      loop: "{{ lookup('pipe', 'awk -F: \'{ if ($3 >= 1000 && $1 != \"root\") print $1 }\' /etc/passwd').splitlines() }}"
      args:
         warn: false




    
