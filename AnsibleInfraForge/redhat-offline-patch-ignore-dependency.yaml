---
- name: Offline patch RHEL 8 using mounted ISO
  hosts: all
  become: true
  vars:
    iso_file: /dev/sr0
    mount_path: /mnt/rhel8-10
    repo_file: /etc/yum.repos.d/rhel8-10-offline.repo

  tasks:

    - name: Ensure mount point exists
      file:
        path: "/mnt/rhel8-10"
        state: directory

    - name: Mount RHEL 8 ISO to /mnt/rhel8-10
      mount:
        src: "/dev/sr0"
        path: "/mnt/rhel8-10"
        fstype: iso9660
        opts: loop,ro
        state: mounted

    - name: Create offline repo pointing to ISO
      copy:
        dest: "/etc/yum.repos.d/rhel8-10-offline.repo"
        content: |
          [rhel-iso]
          name=RHEL 8 BaseOS from ISO
          baseurl=file:///mnt/rhel8-10/BaseOS
          enabled=1
          gpgcheck=0

          [rhel-appstream]
          name=RHEL 8 AppStream from ISO
          baseurl=file:///mnt/rhel8-10/AppStream
          enabled=1
          gpgcheck=0
        mode: '0644'

  
    - name: Ensure safe multilib policy
      lineinfile:
        path: /etc/dnf/dnf.conf
        regexp: '^multilib_policy='
        line: 'multilib_policy=best'
        insertafter: '^\[main\]'
        state: present

    - name: Disable all other repositories (optional for safety)
      command: dnf config-manager --disable \*
      ignore_errors: true

    - name: Clean DNF metadata
      command: dnf clean all

    - name: Rebuild DNF cache from ISO
      command: dnf makecache

    - name: Upgrade using ISO with --best and --allowerasing (supports i686)
      command: >
        dnf --disablerepo="*" 
            --enablerepo="rhel-iso,rhel-appstream"
            upgrade --best --allowerasing -y
      ignore_errors: true

    - name: Unmount ISO
      mount:
        path: "/mnt/rhel8-10"
        state: unmounted

    - name: Remove offline repo file
      file:
        path: "/etc/yum.repos.d/rhel8-10-offline.repo"
        state: absent
